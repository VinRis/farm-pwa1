<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Reports - AgriFlow</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dark-mode.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="main-header">
            <div class="logo-container">
                <button class="back-btn" onclick="navigateTo('index.html')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div>
                    <h1>Master Reports</h1>
                    <p class="tagline">Comprehensive farm analysis</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="menu-btn" onclick="printReport()">
                    <i class="fas fa-print"></i>
                </button>
            </div>
        </header>

        <!-- Report Controls -->
        <div class="section">
            <div class="section-header">
                <h2><i class="fas fa-filter"></i> Report Period</h2>
            </div>
            <div class="period-selector">
                <div class="period-buttons">
                    <button class="period-btn active" onclick="setPeriod('month')">This Month</button>
                    <button class="period-btn" onclick="setPeriod('lastMonth')">Last Month</button>
                    <button class="period-btn" onclick="setPeriod('quarter')">This Quarter</button>
                    <button class="period-btn" onclick="setPeriod('year')">This Year</button>
                </div>
                <div class="custom-period">
                    <input type="date" id="startDate" class="date-input">
                    <span>to</span>
                    <input type="date" id="endDate" class="date-input">
                    <button class="btn-small" onclick="applyCustomPeriod()">Apply</button>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="section">
            <div class="section-header">
                <h2><i class="fas fa-chart-pie"></i> Farm Summary</h2>
                <button class="btn-small" onclick="refreshReport()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="summary-grid">
                <div class="summary-card primary">
                    <div class="summary-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="summary-content">
                        <h3>Total Profit</h3>
                        <div class="summary-value" id="totalProfit">KES 0</div>
                        <div class="summary-trend positive">+0%</div>
                    </div>
                </div>
                <div class="summary-card success">
                    <div class="summary-icon">
                        <i class="fas fa-cow"></i>
                    </div>
                    <div class="summary-content">
                        <h3>Dairy</h3>
                        <div class="summary-value" id="dairyProfit">KES 0</div>
                        <div class="summary-subtitle" id="dairyMilk">0 L milk</div>
                    </div>
                </div>
                <div class="summary-card warning">
                    <div class="summary-icon">
                        <i class="fas fa-egg"></i>
                    </div>
                    <div class="summary-content">
                        <h3>Poultry</h3>
                        <div class="summary-value" id="poultryProfit">KES 0</div>
                        <div class="summary-subtitle" id="poultryEggs">0 eggs</div>
                    </div>
                </div>
                <div class="summary-card info">
                    <div class="summary-icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="summary-content">
                        <h3>Efficiency</h3>
                        <div class="summary-value" id="efficiency">0%</div>
                        <div class="summary-trend neutral">Stable</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="section">
            <div class="section-header">
                <h2><i class="fas fa-chart-bar"></i> Performance Charts</h2>
                <select class="chart-select" onchange="changeChartType()">
                    <option value="profit">Profit Comparison</option>
                    <option value="production">Production</option>
                    <option value="expenses">Expenses</option>
                </select>
            </div>
            <div class="chart-container-large">
                <canvas id="reportChart"></canvas>
            </div>
        </div>

        <!-- Detailed Breakdown -->
        <div class="section">
            <div class="section-header">
                <h2><i class="fas fa-list-alt"></i> Detailed Breakdown</h2>
            </div>
            <div class="tabs">
                <div class="tab-header">
                    <button class="tab-btn active" onclick="showTab('dairy')">
                        <i class="fas fa-cow"></i> Dairy
                    </button>
                    <button class="tab-btn" onclick="showTab('poultry')">
                        <i class="fas fa-egg"></i> Poultry
                    </button>
                    <button class="tab-btn" onclick="showTab('financial')">
                        <i class="fas fa-coins"></i> Financial
                    </button>
                </div>
                
                <div class="tab-content active" id="dairyTab">
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">Total Milk</div>
                            <div class="data-value" id="totalMilk">0 L</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Avg. Daily</div>
                            <div class="data-value" id="avgMilk">0 L</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Milking Cows</div>
                            <div class="data-value" id="milkingCount">0</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Feed Cost</div>
                            <div class="data-value" id="dairyFeedCost">KES 0</div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="poultryTab">
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">Total Eggs</div>
                            <div class="data-value" id="totalEggs">0</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Laying Rate</div>
                            <div class="data-value" id="avgLayingRate">0%</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Total Birds</div>
                            <div class="data-value" id="birdCount">0</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Feed Cost</div>
                            <div class="data-value" id="poultryFeedCost">KES 0</div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="financialTab">
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">Total Income</div>
                            <div class="data-value" id="totalIncome">KES 0</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Total Expenses</div>
                            <div class="data-value" id="totalExpenses">KES 0</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Net Profit</div>
                            <div class="data-value" id="netProfit">KES 0</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Profit Margin</div>
                            <div class="data-value" id="profitMargin">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights & Recommendations -->
        <div class="section">
            <div class="section-header">
                <h2><i class="fas fa-lightbulb"></i> Insights</h2>
            </div>
            <div class="insights-list" id="insightsList">
                <div class="insight-item">
                    <i class="fas fa-info-circle"></i>
                    <p>Start recording production data to get personalized insights</p>
                </div>
            </div>
        </div>

        <!-- Export Options -->
        <div class="section">
            <div class="section-header">
                <h2><i class="fas fa-download"></i> Export Report</h2>
            </div>
            <div class="export-options">
                <button class="export-btn" onclick="exportPDF()">
                    <i class="fas fa-file-pdf"></i>
                    <span>PDF</span>
                </button>
                <button class="export-btn" onclick="exportExcel()">
                    <i class="fas fa-file-excel"></i>
                    <span>Excel</span>
                </button>
                <button class="export-btn" onclick="exportCSV()">
                    <i class="fas fa-file-csv"></i>
                    <span>CSV</span>
                </button>
                <button class="export-btn" onclick="printReport()">
                    <i class="fas fa-print"></i>
                    <span>Print</span>
                </button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="index.html" class="nav-btn">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="dairy.html" class="nav-btn">
                <i class="fas fa-cow"></i>
                <span>Dairy</span>
            </a>
            <a href="poultry.html" class="nav-btn">
                <i class="fas fa-egg"></i>
                <span>Poultry</span>
            </a>
            <a href="master-report.html" class="nav-btn active">
                <i class="fas fa-chart-bar"></i>
                <span>Reports</span>
            </a>
            <a href="settings.html" class="nav-btn">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </nav>
    </div>

    <script src="js/app.js"></script>
    <script src="js/charts.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadReportData();
            generateReport();
            updateNavActiveState();
        });
        
        function loadReportData() {
            const data = JSON.parse(localStorage.getItem('agriflowData')) || {};
            const settings = JSON.parse(localStorage.getItem('agriflowSettings')) || {};
            
            // Update farm info
            document.getElementById('farmName').textContent = settings.farmName || 'My Farm';
            
            // Calculate and update report data
            calculateReportMetrics(data);
        }
        
        function calculateReportMetrics(data) {
            const dairy = data.dairy || { milkProduction: [], animals: [], expenses: [] };
            const poultry = data.poultry || { eggProduction: [], birds: [], expenses: [] };
            
            // Calculate totals
            const totalMilk = dairy.milkProduction.reduce((sum, p) => sum + (p.liters || 0), 0);
            const totalEggs = poultry.eggProduction.reduce((sum, p) => sum + (p.count || 0), 0);
            
            // Calculate profits
            const dairyProfit = dairy.milkProduction.reduce((sum, p) => sum + (p.liters * 50), 0);
            const poultryProfit = poultry.eggProduction.reduce((sum, p) => sum + ((p.count - (p.broken || 0)) * 15), 0);
            const totalProfit = dairyProfit + poultryProfit;
            
            // Update UI
            document.getElementById('totalProfit').textContent = `KES ${totalProfit}`;
            document.getElementById('dairyProfit').textContent = `KES ${dairyProfit}`;
            document.getElementById('poultryProfit').textContent = `KES ${poultryProfit}`;
            document.getElementById('totalMilk').textContent = `${totalMilk} L`;
            document.getElementById('totalEggs').textContent = totalEggs;
            
            // Update insights
            updateInsights(dairy, poultry);
        }
        
        function updateInsights(dairy, poultry) {
            const insightsList = document.getElementById('insightsList');
            const insights = [];
            
            if (dairy.milkProduction.length === 0 && poultry.eggProduction.length === 0) {
                insights.push('Start recording production data to get personalized insights');
            } else {
                if (dairy.milkProduction.length > 0) {
                    const avgMilk = dairy.milkProduction.reduce((s, p) => s + p.liters, 0) / dairy.milkProduction.length;
                    if (avgMilk < 15) insights.push('Consider improving dairy nutrition for better yields');
                    if (dairy.milkProduction.length < 7) insights.push('Record dairy production daily for better tracking');
                }
                
                if (poultry.eggProduction.length > 0) {
                    const avgEggs = poultry.eggProduction.reduce((s, p) => s + p.count, 0) / poultry.eggProduction.length;
                    if (avgEggs < 100) insights.push('Monitor poultry health and feeding schedule');
                    if (poultry.eggProduction.length < 7) insights.push('Track egg production daily for accurate analysis');
                }
            }
            
            if (insights.length === 0) {
                insights.push('All systems optimal. Keep up the good work!');
            }
            
            let html = '';
            insights.forEach(insight => {
                html += `
                    <div class="insight-item">
                        <i class="fas fa-lightbulb"></i>
                        <p>${insight}</p>
                    </div>
                `;
            });
            insightsList.innerHTML = html;
        }
        
        function generateReport() {
            console.log('Generating report...');
            // Report generation logic
        }
        
        function setPeriod(period) {
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            generateReport();
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        function exportPDF() {
            alert('PDF export would be implemented with a backend service. For now, use print.');
            printReport();
        }
        
        function exportExcel() {
            const data = JSON.parse(localStorage.getItem('agriflowData')) || {};
            let csv = 'AgriFlow Report\n\n';
            
            csv += 'Dairy Production\nDate,Liters,Quality\n';
            (data.dairy?.milkProduction || []).forEach(p => {
                csv += `${p.date},${p.liters || 0},${p.quality || ''}\n`;
            });
            
            csv += '\nPoultry Production\nDate,Eggs,Broken\n';
            (data.poultry?.eggProduction || []).forEach(p => {
                csv += `${p.date},${p.count || 0},${p.broken || 0}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `agriflow-report-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function exportCSV() {
            exportExcel(); // Same as Excel for now
        }
        
        function printReport() {
            window.print();
        }
        
        function refreshReport() {
            loadReportData();
            alert('Report refreshed!');
        }
        
        function updateNavActiveState() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('href') === 'master-report.html') {
                    btn.classList.add('active');
                }
            });
        }
    </script>
</body>
</html>